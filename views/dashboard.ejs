<%- include('./partials/head.ejs') %>
  <body>
     <%- include('./partials/header.ejs') %>
    <main>
      <div class="container">
        <div class="blog-form-container">
          <h1>Create new blog</h1>
        <form class="blog-form">
          <input type="text" name="title" id="title" placeholder="Title" />
          <div class="error title"></div>
          <textarea
            name="snippet"
            id="snippet"
            cols="30"
            rows="2"
            placeholder="Snippet"
          ></textarea>
          <div class="error snippet"></div>

          <textarea
            name="body"
            id="body"
            cols="30"
            rows="5"
            placeholder="Body"
          ></textarea>
          <div class="error body"></div>

          <div class="author-info">
            <p>Author:</p>
            <input
              type="text"
              name="author"
              id="author"
              value="<%= user.username %> "
              disabled
            />
          </div>
          <button class="publish-btn">Publish</button>
        </form>
        </div>
        <div class="published-blogs">
          <h1>Recently published blogs</h1>
          <div class="published-blogs-content"></div>
          <div class="vablogs-wrapper">
          <a href="/blogs/<%=user.username %>" class="vablogs">view all blogs <i class="fas fa-caret-right"></i></a>
          </div>
        </div>
      </div>


    </main>
    <script>
      const title = document.querySelector("#title");
      const snippet = document.querySelector("#snippet");
      const body = document.querySelector("#body");
      const author = document.querySelector("#author");
      const publishBtn = document.querySelector(".publish-btn");
      const publishedBlogsContent = document.querySelector(
        ".published-blogs-content"
      );

      // error
      const titleErr = document.querySelector(".error.title");
      const snippetErr = document.querySelector(".error.snippet");
      const bodyErr = document.querySelector(".error.body");

      publishBtn.addEventListener("click", async (e) => {
        e.preventDefault();

        try {
          const data = {
            title: title.value,
            snippet: snippet.value,
            body: body.value,
            author: author.value.replace(" ", ""),
          };
          const res = await fetch("/blog", {
            headers: { "Content-Type": "application/json" },
            method: "POST",
            body: JSON.stringify(data),
          });

          const resp = await res.json();
         

          if (resp.message == "success") {
            location.assign("/dashboard");
          }

          if (resp.errors) {
            titleErr.innerHTML = resp.errors.title;
            snippetErr.innerHTML = resp.errors.snippet;
            bodyErr.innerHTML = resp.errors.body;
          }
        } catch (err) {
          console.log(err);
        }
      });

      // fetch all blogs posted by logged in user
      const getBlogs = async () => {
        try {
          const res = await fetch("/user/blogs");
          const { blogs } = await res.json();
        
          if (blogs) {
            blogs.forEach((blog) => {
              publishedBlogsContent.innerHTML += ` 
              <a href="/blog/${blog.author}/${blog._id}" class="blog">
                <h2 class="blog-title">${blog.title}</h2>
                <p class="blog-snippet">
                ${blog.snippet}
                </p>
              </a> 
              `;
            });
          }
        } catch (err) {
          console.log(err);
        }
      };

      getBlogs();
    </script>
  </body>
</html>
